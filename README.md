動作環境:Node.js 18以上


1. Next.jsのインストール

```
npx create-next-app@latest chat-app --ts --tailwind --eslint --app --no-src-dir --import-alias "@/*"
```

2. 確認

```
npm run dev
```

http://localhost:3000


```
Need to install the following packages:
create-next-app@14.2.15
Ok to proceed? (y) y
```


2. shadcnのインストール(UI コンポーネント)

```
npx shadcn@latest init
```

```
Need to install the following packages:
shadcn@2.1.0
Ok to proceed? (y) y
```


```
Which style would you like to use? › Default
Which color would you like to use as base color? › Slate
Do you want to use CSS variables for colors? › yes
```

3. Vercel AI SDKのインストール

```
npm i ai @ai-sdk/google
```

4. 生成AIのAPIへの共通関数の作成

model.tsの作成

```
touch lib/model.ts
```

```
// model.ts
import { createGoogleGenerativeAI } from "@ai-sdk/google";
import { env } from "node:process";

export function getGoogleGenerativeAI() {
  const google = createGoogleGenerativeAI({
    "apiKey": env.GOOGLE_GENERATIVE_AI_API_KEY
  });

  return google(env.GOOGLE_GENERATIVE_AI_MODEL || "gemini-1.5-flash-latest");
}
```

5. 環境変数の設定

.env.localの作成

```
touch .env.local
```

```
GOOGLE_GENERATIVE_AI_API_KEY=
GOOGLE_GENERATIVE_AI_MODEL=gemini-1.5-flash-002
```


6. レイアウトファイルの変更

app/layout.tsxの修正

```
// layout.tsx
import type { Metadata } from "next";
import localFont from "next/font/local";
import "./globals.css";

const geistSans = localFont({
  src: "./fonts/GeistVF.woff",
  variable: "--font-geist-sans",
  weight: "100 900",
});
const geistMono = localFont({
  src: "./fonts/GeistMonoVF.woff",
  variable: "--font-geist-mono",
  weight: "100 900",
});

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="ja">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased bg-white`}
      >
        <div className="flex flex-col h-screen">
          <header className="h-16 bg-black text-white">
            <div className="container mx-auto flex items-center justify-center h-full">
              <h1 className="text-lg font-bold">Gemini APIを利用したチャットアプリ</h1>
            </div>
          </header>
          <main className="flex-grow overflow-hidden">
            {children}
          </main>
        </div>
      </body>
    </html>
  );
}
```

6. route.ts

TODO: ディレクトリの作成



```
import { getGoogleGenerativeAI } from '@/lib/model';
import { convertToCoreMessages, streamText } from 'ai';

export async function POST(req: Request) {
  const { messages } = await req.json();

  const result = await streamText({
    model: getGoogleGenerativeAI(),
    messages: convertToCoreMessages(messages),
  });

  return result.toDataStreamResponse();
}
```

7. page.tsx

```
'use client';

import { useChat } from 'ai/react';
import { useRef, useState } from 'react';
import Image from 'next/image';

export default function Chat() {
  const { messages, input, handleInputChange, handleSubmit } = useChat();

  const [files, setFiles] = useState<FileList | undefined>(undefined);
  const fileInputRef = useRef<HTMLInputElement>(null);

  return (
    <div className="flex flex-col w-full max-w-md py-24 mx-auto stretch">
      {messages.map(m => (
        <div key={m.id} className="whitespace-pre-wrap">
          {m.role === 'user' ? 'User: ' : 'AI: '}
          {m.content}
          <div>
            {m?.experimental_attachments
              ?.filter(attachment =>
                attachment?.contentType?.startsWith('image/'),
              )
              .map((attachment, index) => (
                <Image
                  key={`${m.id}-${index}`}
                  src={attachment.url}
                  width={500}
                  height={500}
                  alt={attachment.name ?? `attachment-${index}`}
                />
              ))}
          </div>
        </div>
      ))}

      <form
        className="fixed bottom-0 w-full max-w-md p-2 mb-8 border border-gray-300 rounded shadow-xl space-y-2"
        onSubmit={event => {
          handleSubmit(event, {
            experimental_attachments: files,
          });

          setFiles(undefined);

          if (fileInputRef.current) {
            fileInputRef.current.value = '';
          }
        }}
      >
        <input
          type="file"
          className=""
          onChange={event => {
            if (event.target.files) {
              setFiles(event.target.files);
            }
          }}
          multiple
          ref={fileInputRef}
        />
        <input
          className="w-full p-2"
          value={input}
          placeholder="Say something..."
          onChange={handleInputChange}
        />
      </form>
    </div>
  );
}
```